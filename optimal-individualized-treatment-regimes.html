<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 5 Optimal Individualized Treatment Regimes | The tlverse Software Ecosystem for Causal Inference</title>
  <meta name="description" content="An open-source and fully-reproducible electronic set of teaching materials accompanying a full-day short-course on applying the Targeted Learning methodology in practice using the tlverse software ecosystem." />
  <meta name="generator" content="bookdown 0.10.2 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 5 Optimal Individualized Treatment Regimes | The tlverse Software Ecosystem for Causal Inference" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://tlverse.org/acic2019-workshop/" />
  
  <meta property="og:description" content="An open-source and fully-reproducible electronic set of teaching materials accompanying a full-day short-course on applying the Targeted Learning methodology in practice using the tlverse software ecosystem." />
  <meta name="github-repo" content="tlverse/acic2019-workshop" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 5 Optimal Individualized Treatment Regimes | The tlverse Software Ecosystem for Causal Inference" />
  
  <meta name="twitter:description" content="An open-source and fully-reproducible electronic set of teaching materials accompanying a full-day short-course on applying the Targeted Learning methodology in practice using the tlverse software ecosystem." />
  

<meta name="author" content="Mark van der Laan, Alan Hubbard, Jeremy Coyle, Nima Hejazi, Ivana Malenica, Rachael Phillips" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="img/logos/favicons/favicon.png" type="image/x-icon" />
<link rel="prev" href="the-tmle-framework.html">
<link rel="next" href="stochastic-treatment-regimes.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<script src="libs/htmlwidgets-1.3/htmlwidgets.js"></script>
<link href="libs/vis-4.20.1/vis.css" rel="stylesheet" />
<script src="libs/vis-4.20.1/vis.min.js"></script>
<script src="libs/visNetwork-binding-2.0.6/visNetwork.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">ACIC 2019 tlverse software workshop</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#important-links"><i class="fa fa-check"></i>Important links</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#about-this-workshop"><i class="fa fa-check"></i>About this workshop</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#outline"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#about-the-instructors"><i class="fa fa-check"></i>About the instructors</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#mark-van-der-laan"><i class="fa fa-check"></i>Mark van der Laan</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#alan-hubbard"><i class="fa fa-check"></i>Alan Hubbard</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#jeremy-coyle"><i class="fa fa-check"></i>Jeremy Coyle</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#nima-hejazi"><i class="fa fa-check"></i>Nima Hejazi</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#ivana-malenica"><i class="fa fa-check"></i>Ivana Malenica</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#rachael-phillips"><i class="fa fa-check"></i>Rachael Phillips</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="motivation.html"><a href="motivation.html"><i class="fa fa-check"></i>Motivation</a></li>
<li class="chapter" data-level="1" data-path="tlverse.html"><a href="tlverse.html"><i class="fa fa-check"></i><b>1</b> Welcome to the <code>tlverse</code></a><ul>
<li class="chapter" data-level="1.1" data-path="tlverse.html"><a href="tlverse.html#learning-objectives"><i class="fa fa-check"></i><b>1.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="1.2" data-path="tlverse.html"><a href="tlverse.html#what-is-the-tlverse"><i class="fa fa-check"></i><b>1.2</b> What is the <code>tlverse</code>?</a></li>
<li class="chapter" data-level="1.3" data-path="tlverse.html"><a href="tlverse.html#tlverse-components"><i class="fa fa-check"></i><b>1.3</b> <code>tlverse</code> components</a></li>
<li class="chapter" data-level="1.4" data-path="tlverse.html"><a href="tlverse.html#installtlverse"><i class="fa fa-check"></i><b>1.4</b> Installation</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>2</b> The Targeted Learning Roadmap</a><ul>
<li class="chapter" data-level="2.1" data-path="intro.html"><a href="intro.html#the-statistical-model"><i class="fa fa-check"></i><b>2.1</b> The Statistical Model</a></li>
<li class="chapter" data-level="2.2" data-path="intro.html"><a href="intro.html#the-causal-model"><i class="fa fa-check"></i><b>2.2</b> The Causal Model</a></li>
<li class="chapter" data-level="2.3" data-path="intro.html"><a href="intro.html#the-parameter-of-interest"><i class="fa fa-check"></i><b>2.3</b> The Parameter of Interest</a></li>
<li class="chapter" data-level="2.4" data-path="intro.html"><a href="intro.html#identifiability"><i class="fa fa-check"></i><b>2.4</b> Identifiability</a></li>
<li class="chapter" data-level="2.5" data-path="intro.html"><a href="intro.html#estimators-superlearning-and-targeted-maximum-likelihood"><i class="fa fa-check"></i><b>2.5</b> Estimators: SuperLearning and Targeted Maximum Likelihood</a><ul>
<li class="chapter" data-level="2.5.1" data-path="intro.html"><a href="intro.html#superlearning"><i class="fa fa-check"></i><b>2.5.1</b> SuperLearning</a></li>
<li class="chapter" data-level="2.5.2" data-path="intro.html"><a href="intro.html#substitution-estimators"><i class="fa fa-check"></i><b>2.5.2</b> Substitution Estimators</a></li>
<li class="chapter" data-level="2.5.3" data-path="intro.html"><a href="intro.html#tmle"><i class="fa fa-check"></i><b>2.5.3</b> TMLE</a></li>
<li class="chapter" data-level="2.5.4" data-path="intro.html"><a href="intro.html#inference"><i class="fa fa-check"></i><b>2.5.4</b> Inference</a></li>
</ul></li>
<li class="chapter" data-level="2.6" data-path="intro.html"><a href="intro.html#the-wash-benefits-example-dataset"><i class="fa fa-check"></i><b>2.6</b> The WASH Benefits Example Dataset</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="ensemble-machine-learning.html"><a href="ensemble-machine-learning.html"><i class="fa fa-check"></i><b>3</b> Ensemble Machine Learning</a><ul>
<li class="chapter" data-level="3.1" data-path="ensemble-machine-learning.html"><a href="ensemble-machine-learning.html#learning-objectives-1"><i class="fa fa-check"></i><b>3.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="3.2" data-path="ensemble-machine-learning.html"><a href="ensemble-machine-learning.html#introduction"><i class="fa fa-check"></i><b>3.2</b> Introduction</a></li>
<li class="chapter" data-level="3.3" data-path="ensemble-machine-learning.html"><a href="ensemble-machine-learning.html#basic-sl3-implementation"><i class="fa fa-check"></i><b>3.3</b> Basic <code>sl3</code> Implementation</a><ul>
<li class="chapter" data-level="" data-path="ensemble-machine-learning.html"><a href="ensemble-machine-learning.html#wash-benefits-study-example"><i class="fa fa-check"></i>WASH Benefits Study Example</a></li>
<li class="chapter" data-level="" data-path="ensemble-machine-learning.html"><a href="ensemble-machine-learning.html#load-the-necessary-libraries-and-data"><i class="fa fa-check"></i>0. Load the necessary libraries and data</a></li>
<li class="chapter" data-level="" data-path="ensemble-machine-learning.html"><a href="ensemble-machine-learning.html#define-the-machine-learning-task"><i class="fa fa-check"></i>1. Define the machine learning task</a></li>
<li class="chapter" data-level="" data-path="ensemble-machine-learning.html"><a href="ensemble-machine-learning.html#make-a-super-learner"><i class="fa fa-check"></i>2. Make a super learner</a></li>
<li class="chapter" data-level="" data-path="ensemble-machine-learning.html"><a href="ensemble-machine-learning.html#train-the-super-learner-on-the-machine-learning-task"><i class="fa fa-check"></i>3. Train the super learner on the machine learning task</a></li>
<li class="chapter" data-level="" data-path="ensemble-machine-learning.html"><a href="ensemble-machine-learning.html#obtain-predicted-values"><i class="fa fa-check"></i>4. Obtain predicted values</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="ensemble-machine-learning.html"><a href="ensemble-machine-learning.html#extensions"><i class="fa fa-check"></i><b>3.4</b> Extensions</a><ul>
<li class="chapter" data-level="3.4.1" data-path="ensemble-machine-learning.html"><a href="ensemble-machine-learning.html#cross-validated-super-learner"><i class="fa fa-check"></i><b>3.4.1</b> Cross-validated Super Learner</a></li>
<li class="chapter" data-level="3.4.2" data-path="ensemble-machine-learning.html"><a href="ensemble-machine-learning.html#variable-importance-measures-with-sl3"><i class="fa fa-check"></i><b>3.4.2</b> Variable Importance Measures with <code>sl3</code></a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="ensemble-machine-learning.html"><a href="ensemble-machine-learning.html#exercise"><i class="fa fa-check"></i><b>3.5</b> Exercise</a><ul>
<li class="chapter" data-level="3.5.1" data-path="ensemble-machine-learning.html"><a href="ensemble-machine-learning.html#predicting-myocardial-infarction-with-sl3"><i class="fa fa-check"></i><b>3.5.1</b> Predicting Myocardial Infarction with <code>sl3</code></a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="ensemble-machine-learning.html"><a href="ensemble-machine-learning.html#summary"><i class="fa fa-check"></i><b>3.6</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html"><i class="fa fa-check"></i><b>4</b> The TMLE Framework</a><ul>
<li class="chapter" data-level="4.1" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#learning-objectives-2"><i class="fa fa-check"></i><b>4.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="4.2" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#easy-bake-example-tmle3-for-ate"><i class="fa fa-check"></i><b>4.2</b> Easy-Bake Example: <code>tmle3</code> for ATE</a><ul>
<li class="chapter" data-level="" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#load-the-data"><i class="fa fa-check"></i>0. Load the Data</a></li>
<li class="chapter" data-level="" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#define-the-variable-roles"><i class="fa fa-check"></i>1. Define the variable roles</a></li>
<li class="chapter" data-level="" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#create-a-spec-object"><i class="fa fa-check"></i>2. Create a “Spec” Object</a></li>
<li class="chapter" data-level="" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#define-the-relevant-super-learners"><i class="fa fa-check"></i>3. Define the Relevant Super Learners</a></li>
<li class="chapter" data-level="" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#fit-the-tmle"><i class="fa fa-check"></i>4. Fit the TMLE</a></li>
<li class="chapter" data-level="" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#evaluate-the-estimates"><i class="fa fa-check"></i>5. Evaluate the Estimates</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#tmle3-components"><i class="fa fa-check"></i><b>4.3</b> <code>tmle3</code> Components</a><ul>
<li class="chapter" data-level="4.3.1" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#tmle3_task"><i class="fa fa-check"></i><b>4.3.1</b> <code>tmle3_task</code></a></li>
<li class="chapter" data-level="4.3.2" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#initial-likelihood"><i class="fa fa-check"></i><b>4.3.2</b> Initial Likelihood</a></li>
<li class="chapter" data-level="4.3.3" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#targeted-likelihood-updater"><i class="fa fa-check"></i><b>4.3.3</b> Targeted Likelihood (updater)</a></li>
<li class="chapter" data-level="4.3.4" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#parameter-mapping"><i class="fa fa-check"></i><b>4.3.4</b> Parameter Mapping</a></li>
<li class="chapter" data-level="4.3.5" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#putting-it-all-together"><i class="fa fa-check"></i><b>4.3.5</b> Putting it all together</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#fitting-tmle3-with-multiple-parameters"><i class="fa fa-check"></i><b>4.4</b> Fitting <code>tmle3</code> with multiple parameters</a><ul>
<li class="chapter" data-level="4.4.1" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#delta-method"><i class="fa fa-check"></i><b>4.4.1</b> Delta Method</a></li>
<li class="chapter" data-level="4.4.2" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#fit"><i class="fa fa-check"></i><b>4.4.2</b> Fit</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#exercise-1"><i class="fa fa-check"></i><b>4.5</b> Exercise</a></li>
<li class="chapter" data-level="4.6" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#summary-1"><i class="fa fa-check"></i><b>4.6</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html"><i class="fa fa-check"></i><b>5</b> Optimal Individualized Treatment Regimes</a><ul>
<li class="chapter" data-level="5.1" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#learning-objectives-3"><i class="fa fa-check"></i><b>5.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="5.2" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#introduction-to-optimal-individualized-interventions"><i class="fa fa-check"></i><b>5.2</b> Introduction to Optimal Individualized Interventions</a></li>
<li class="chapter" data-level="5.3" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#data-structure-and-notation"><i class="fa fa-check"></i><b>5.3</b> Data Structure and Notation</a></li>
<li class="chapter" data-level="5.4" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#defining-the-causal-effect-of-an-optimal-individualized-intervention"><i class="fa fa-check"></i><b>5.4</b> Defining the Causal Effect of an Optimal Individualized Intervention</a><ul>
<li class="chapter" data-level="5.4.1" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#why-cv-tmle"><i class="fa fa-check"></i><b>5.4.1</b> Why CV-TMLE?</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#binary-treatment"><i class="fa fa-check"></i><b>5.5</b> Binary Treatment</a><ul>
<li class="chapter" data-level="5.5.1" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#evaluating-the-causal-effect-of-an-optimal-itr-with-binary-treatment"><i class="fa fa-check"></i><b>5.5.1</b> Evaluating the Causal Effect of an optimal ITR with Binary Treatment</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#categorical-treatment"><i class="fa fa-check"></i><b>5.6</b> Categorical Treatment</a><ul>
<li class="chapter" data-level="5.6.1" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#evaluating-the-causal-effect-of-an-optimal-itr-with-categorical-treatment"><i class="fa fa-check"></i><b>5.6.1</b> Evaluating the Causal Effect of an optimal ITR with Categorical Treatment</a></li>
</ul></li>
<li class="chapter" data-level="5.7" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#extensions-to-causal-effect-of-an-oit"><i class="fa fa-check"></i><b>5.7</b> Extensions to Causal Effect of an OIT</a><ul>
<li class="chapter" data-level="5.7.1" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#simpler-rules"><i class="fa fa-check"></i><b>5.7.1</b> Simpler Rules</a></li>
<li class="chapter" data-level="5.7.2" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#realistic-optimal-individual-regimes"><i class="fa fa-check"></i><b>5.7.2</b> Realistic Optimal Individual Regimes</a></li>
<li class="chapter" data-level="5.7.3" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#variable-importance-analysis"><i class="fa fa-check"></i><b>5.7.3</b> Variable Importance Analysis</a></li>
</ul></li>
<li class="chapter" data-level="5.8" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#exercise-2"><i class="fa fa-check"></i><b>5.8</b> Exercise</a><ul>
<li class="chapter" data-level="5.8.1" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#real-world-data-and-tmle3mopttx"><i class="fa fa-check"></i><b>5.8.1</b> Real World Data and <code>tmle3mopttx</code></a></li>
</ul></li>
<li class="chapter" data-level="5.9" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#summary-2"><i class="fa fa-check"></i><b>5.9</b> Summary</a><ul>
<li class="chapter" data-level="5.9.1" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#solutions"><i class="fa fa-check"></i><b>5.9.1</b> Solutions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html"><i class="fa fa-check"></i><b>6</b> Stochastic Treatment Regimes</a><ul>
<li class="chapter" data-level="6.1" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#learning-objectives-4"><i class="fa fa-check"></i><b>6.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="6.2" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#introduction-1"><i class="fa fa-check"></i><b>6.2</b> Introduction</a></li>
<li class="chapter" data-level="6.3" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#stochastic-interventions"><i class="fa fa-check"></i><b>6.3</b> Stochastic Interventions</a><ul>
<li class="chapter" data-level="6.3.1" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#identifying-the-causal-effect-of-a-stochastic-intervention"><i class="fa fa-check"></i><b>6.3.1</b> Identifying the Causal Effect of a Stochastic Intervention</a></li>
<li class="chapter" data-level="6.3.2" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#interpreting-the-causal-effect-of-a-stochastic-intervention"><i class="fa fa-check"></i><b>6.3.2</b> Interpreting the Causal Effect of a Stochastic Intervention</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#estimating-the-causal-effect-of-a-stochastic-intervention-with-tmle3shift"><i class="fa fa-check"></i><b>6.4</b> Estimating the Causal Effect of a Stochastic Intervention with <code>tmle3shift</code></a><ul>
<li class="chapter" data-level="6.4.1" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#simulate-data-1"><i class="fa fa-check"></i><b>6.4.1</b> Simulate Data</a></li>
<li class="chapter" data-level="6.4.2" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#targeted-estimation-of-stochastic-interventions-effects"><i class="fa fa-check"></i><b>6.4.2</b> Targeted Estimation of Stochastic Interventions Effects</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#stochastic-interventions-over-a-grid-of-counterfactual-shifts"><i class="fa fa-check"></i><b>6.5</b> Stochastic Interventions over a Grid of Counterfactual Shifts</a><ul>
<li class="chapter" data-level="6.5.1" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#initializing-vimshift-through-its-tmle3_spec"><i class="fa fa-check"></i><b>6.5.1</b> Initializing <code>vimshift</code> through its <code>tmle3_Spec</code></a></li>
<li class="chapter" data-level="6.5.2" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#targeted-estimation-of-stochastic-intervention-effects"><i class="fa fa-check"></i><b>6.5.2</b> Targeted Estimation of Stochastic Intervention Effects</a></li>
<li class="chapter" data-level="6.5.3" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#inference-with-marginal-structural-models"><i class="fa fa-check"></i><b>6.5.3</b> Inference with Marginal Structural Models</a></li>
<li class="chapter" data-level="6.5.4" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#directly-targeting-the-msm-parameter-beta"><i class="fa fa-check"></i><b>6.5.4</b> Directly Targeting the MSM Parameter <span class="math inline">\(\beta\)</span></a></li>
<li class="chapter" data-level="6.5.5" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#example-with-the-wash-benefits-data"><i class="fa fa-check"></i><b>6.5.5</b> Example with the WASH Benefits Data</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#exercises"><i class="fa fa-check"></i><b>6.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="r6.html"><a href="r6.html"><i class="fa fa-check"></i><b>7</b> A Primer on the <code>R6</code> Class System</a><ul>
<li class="chapter" data-level="7.1" data-path="r6.html"><a href="r6.html#classes-fields-and-methods"><i class="fa fa-check"></i><b>7.1</b> Classes, Fields, and Methods</a></li>
<li class="chapter" data-level="7.2" data-path="r6.html"><a href="r6.html#object-oriented-programming-python-and-r"><i class="fa fa-check"></i><b>7.2</b> Object Oriented Programming: <code>Python</code> and <code>R</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">The <code>tlverse</code> Software Ecosystem for Causal Inference</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="optimal-individualized-treatment-regimes" class="section level1">
<h1><span class="header-section-number">Chapter 5</span> Optimal Individualized Treatment Regimes</h1>
<p><em>Ivana Malenica</em></p>
<p>Based on the <a href="https://github.com/tlverse/tmle3mopttx"><code>tmle3mopttx</code> <code>R</code> package</a>
by <em>Ivana Malenica, Jeremy Coyle, and Mark van der Laan</em>.</p>
<p>Updated: 2019-05-22</p>
<div id="learning-objectives-3" class="section level2">
<h2><span class="header-section-number">5.1</span> Learning Objectives</h2>
<p>By the end of this lesson you will be able to:</p>
<ol style="list-style-type: decimal">
<li>Differentiate dynamic and optimal dynamic treatment interventions from static
interventions.</li>
<li>Explain the benefits and challenges associated with using optimal
individualized treatment regimes in practice.</li>
<li>Contrast the impact of implementing an optimal individualized treatment
regime in the population with the impact of implementing static and dynamic
treatment regimes in the population.</li>
<li>Estimate causal effects under optimal individualized treatment regimes with
the <code>tmle3mopttx</code> <code>R</code> package.</li>
<li>Implement optimal individualized treatment rules based on sub-optimal
rules, or “simple” rules, and recognize the practical benefit of these rules.</li>
<li>Construct “realistic” optimal individualized treatment regimes that respect
real data and subject-matter knowledge limitations on interventions by
only considering interventions that are supported by the data.</li>
<li>Measure variable importance as defined in terms of optimal individualized
treatment interventions.</li>
</ol>
</div>
<div id="introduction-to-optimal-individualized-interventions" class="section level2">
<h2><span class="header-section-number">5.2</span> Introduction to Optimal Individualized Interventions</h2>
<p>Identifying which intervention will be effective for which patient
based on lifestyle, genetic and environmental factors is a common goal in
precision medicine. One opts to administer the intervention to individuals
who will profit from it, instead of assigning treatment on a population level.</p>
<ul>
<li><p>This aim motivates a different type of intervention, as opposed to the static
exposures we might be used to.</p></li>
<li><p>In this chapter, we learn about dynamic
(individualized) interventions that tailor the treatment decision based on the
collected covariates.</p></li>
<li><p>In the statistics community, such a treatment strategy is
termed <strong>individualized treatment regimes</strong> (ITR), and the (counterfactual) population
mean outcome under an ITR is the <strong>value of the ITR</strong>.</p></li>
<li><p>Even more, suppose one wishes
to maximize the population mean of an outcome, where for each individual we have
access to some set of measured covariates. An ITR with the maximal value is referred
to as an <strong>optimal ITR</strong> or the <strong>optimal individualized treatment</strong>.
Consequently, the value of an optimal ITR is termed the <strong>optimal value</strong>, or the
<strong>mean under the optimal individualized treatment</strong>.</p></li>
<li><p>One opts to administer the intervention to individuals who will profit from it, instead of
assigning treatment on a population level. But how do we know which intervention works for which
patient?</p></li>
<li><p>For example, one might seek to improve retention in
HIV care. In a randomized clinical trial, several interventions show efficacy- including
appointment reminders through text messages, small cash incentives for on time clinic
visits, and peer health workers.</p></li>
<li><p>Ideally, we want to improve effectiveness by assigning
each patient the intervention they are most likely to benefit from, as well as improve
efficiency by not allocating resources to individuals that do not need them, or would</p></li>
</ul>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-2"></span>
<img src="img/image/DynamicA_Illustration.png" alt="Illustration of a Dynamic Treatment Regime in a Clinical Setting" width="60%" />
<p class="caption">
Figure 5.1: Illustration of a Dynamic Treatment Regime in a Clinical Setting
</p>
</div>
<p>This aim motivates a different type of intervention, as opposed to the static exposures we
might be used to.</p>
<ul>
<li><p>In this chapter, we examine multiple examples of optimal individualized
treatment regimes
and estimate the mean outcome under the ITR
where the candidate rules are restricted to depend only on user-supplied subset of the
baseline covariates.</p></li>
<li><p>In order to accomplish this, we present the <a href="https://github.com/tlverse/tmle3mopttx"><code>tmle3mopttx</code> R
package</a>, which features an
implementation of a recently developed algorithm for computing targeted minimum
loss-based estimates of a causal effect based on optimal ITR for
categorical treatment.</p></li>
<li><p>In particular, we will use <code>tmle3mopttx</code> to estimate
optimal ITR and the corresponding population value,
construct realistic optimal ITRs, and perform variable importance in terms of the
mean under the optimal individualized treatment.</p></li>
</ul>
</div>
<div id="data-structure-and-notation" class="section level2">
<h2><span class="header-section-number">5.3</span> Data Structure and Notation</h2>
<ul>
<li><p>Suppose we observe <span class="math inline">\(n\)</span> independent and identically distributed observations of
the form <span class="math inline">\(O=(W,A,Y) \sim P_0\)</span>. <span class="math inline">\(P_0 \in \mathcal{M}\)</span>, where <span class="math inline">\(\mathcal{M}\)</span> is the
fully nonparametric model.</p></li>
<li><p>Denote <span class="math inline">\(A \in \mathcal{A}\)</span> as categorical treatment, where
<span class="math inline">\(\mathcal{A} \equiv \{a_1, \cdots, a_{n_A} \}\)</span> and <span class="math inline">\(n_A = |\mathcal{A}|\)</span>, with
<span class="math inline">\(n_A\)</span> denoting the number of categories.</p></li>
<li><p>Denote <span class="math inline">\(Y\)</span> as the final outcome, and <span class="math inline">\(W\)</span> a vector-valued collection of baseline
covariates.</p></li>
<li><p>The likelihood of the data admits a factorization, implied by the time ordering of <span class="math inline">\(O\)</span>.
<span class="math display">\[\begin{equation*}\label{eqn:likelihood_factorization}
p_0(O) = p_{Y,0}(Y|A,W) p_{A,0}(A|W) p_{W,0}(W) = q_{Y,0}(Y|A,W) q_{A,0}(A|W) q_{W,0}(W),
\end{equation*}\]</span></p></li>
<li><p>Consequently, we define
<span class="math inline">\(P_{Y,0}(Y|A,W)=Q_{Y,0}(Y|A,W)\)</span>, <span class="math inline">\(P_{A,0}(A|W)=g_0(A|W)\)</span> and <span class="math inline">\(P_{W,0}(W)=Q_{W,0}(W)\)</span> as the
corresponding conditional distributions of <span class="math inline">\(Y\)</span>, <span class="math inline">\(A\)</span> and <span class="math inline">\(W\)</span>.</p></li>
<li><p>We also define <span class="math inline">\(\bar{Q}_{Y,0}(A,W) \equiv E_0[Y|A,W]\)</span>.</p></li>
<li><p>Finally, denote <span class="math inline">\(V\)</span> as <span class="math inline">\(V \in W\)</span>, defining a subset of the baseline covariates
the optimal individualized rule depends on.</p></li>
</ul>
</div>
<div id="defining-the-causal-effect-of-an-optimal-individualized-intervention" class="section level2">
<h2><span class="header-section-number">5.4</span> Defining the Causal Effect of an Optimal Individualized Intervention</h2>
<ul>
<li><p>Consider dynamic treatment rules <span class="math inline">\(V \rightarrow d(V) \in \{a_1, \cdots, a_{n_A} \} \times \{1\}\)</span>,
for assigning treatment <span class="math inline">\(A\)</span> based on <span class="math inline">\(V \in W\)</span>.</p></li>
<li><p>Dynamic treatment regime may be viewed as an intervention in which
<span class="math inline">\(A\)</span> is set equal to a value based on a hypothetical regime <span class="math inline">\(d(V)\)</span>, and <span class="math inline">\(Y_{d(V)}\)</span>
is the corresponding counterfactual outcome under <span class="math inline">\(d(V)\)</span>.</p></li>
<li><p>The goal of any causal analysis motivated by an optimal individualized
intervention is to estimate a parameter defined as the counterfactual mean of the outcome with
respect to the modified intervention distribution.</p></li>
<li><p>Recall causal assumptions:</p></li>
</ul>
<ol style="list-style-type: decimal">
<li><strong>Consistency</strong>: <span class="math inline">\(Y^{d(v_i)}_i = Y_i\)</span> in the event <span class="math inline">\(A_i = d(v_i)\)</span>,
for <span class="math inline">\(i = 1, \ldots, n\)</span>.</li>
<li><strong>Stable unit value treatment assumption (SUTVA)</strong>: <span class="math inline">\(Y^{d(v_i)}_i\)</span> does
not depend on <span class="math inline">\(d(v_j)\)</span> for <span class="math inline">\(i = 1, \ldots, n\)</span> and <span class="math inline">\(j \neq i\)</span>, or lack
of interference.</li>
<li><strong>Strong ignorability</strong>: <span class="math inline">\(A \perp \!\!\! \perp Y^{d(v)} \mid W\)</span>, for all <span class="math inline">\(a \in \mathcal{A}\)</span>.</li>
<li><strong>Positivity (or overlap)</strong>: <span class="math inline">\(P_0(\min_{a \in \mathcal{A}} g_0(a|W) &gt; 0)=1\)</span></li>
</ol>
<ul>
<li><p>Here, we also assume non-exceptional law is in effect.</p></li>
<li><p>We are primarily interested in the value of an individualized rule,
<span class="math display">\[E_0[Y_{d(V)}] = E_{0,W}[\bar{Q}_{Y,0}(A=d(V),W)].\]</span></p></li>
<li><p>The optimal rule is the rule with the maximal value:
<span class="math display">\[d_{opt}(V) \equiv \text{argmax}_{d(V) \in \mathcal{D}} E_0[Y_{d(V)}] \]</span>
where <span class="math inline">\(\mathcal{D}\)</span> represents the set of possible rules, <span class="math inline">\(d\)</span>, implied by <span class="math inline">\(V\)</span>.</p></li>
<li><p>The target causal estimand of our analysis is:
<span class="math display">\[\psi_0 := E_0[Y_{d_{opt}(V)}] =  E_{0,W}[\bar{Q}_{Y,0}(A=d_{opt}(V),W)].\]</span></p></li>
<li><p>General, high-level idea:</p></li>
</ul>
<ol style="list-style-type: decimal">
<li><p>Learn the optimal ITR using the Super Learner.</p></li>
<li><p>Estimate its value with the cross-validated Targeted Minimum Loss-based
Estimator (CV-TMLE).</p></li>
</ol>
<div id="why-cv-tmle" class="section level3">
<h3><span class="header-section-number">5.4.1</span> Why CV-TMLE?</h3>
<ul>
<li><p>CV-TMLE is necessary as the non-cross-validated TMLE
is biased upward for the mean outcome under the rule, and therefore overly optimistic.</p></li>
<li><p>More generally however, using CV-TMLE allows us more freedom in estimation and therefore greater
data adaptivity, without sacrificing inference!</p></li>
</ul>
</div>
</div>
<div id="binary-treatment" class="section level2">
<h2><span class="header-section-number">5.5</span> Binary Treatment</h2>
<ul>
<li><p>How do we estimate the optimal individualized treatment regime? In the case of a
binary treatment, a key quantity for optimal ITR is the <strong>blip</strong> function.</p></li>
<li><p>Optimal ITR ideally assigns treatment to individuals falling in strata in which the
stratum specific average treatment effect, the <strong>blip</strong> function, is positive and does not
assign treatment to individuals for which this quantity is negative.</p></li>
<li><p>We define the blip function as:
<span class="math display">\[\bar{Q}_0(V) \equiv E_0[Y_1-Y_0|V] \equiv E_0[\bar{Q}_{Y,0}(1,W) - \bar{Q}_{Y,0}(0,W) | V], \]</span>
or the average treatment effect within a stratum of <span class="math inline">\(V\)</span>.</p></li>
<li><p>Optimal individualized
rule can now be derived as <span class="math inline">\(d_{opt}(V) = I(\bar{Q}_{0}(V) &gt; 0)\)</span>.</p></li>
<li><p>Relying on the Targeted Maximum Likelihood (TML) estimator and the Super Learner estimate of the
blip function, we follow the below steps in order to obtain value of the ITR:</p></li>
</ul>
<ol style="list-style-type: decimal">
<li><p>Estimate <span class="math inline">\(\bar{Q}_{Y,0}(A,W)\)</span> and <span class="math inline">\(g_0(A|W)\)</span> using <code>sl3</code>. We denote such estimates
as <span class="math inline">\(\bar{Q}_{Y,n}(A,W)\)</span> and <span class="math inline">\(g_n(A|W)\)</span>.</p></li>
<li><p>Apply the doubly robust Augmented-Inverse Probability Weighted (A-IPW) transform to
our outcome, where we define:</p></li>
</ol>
<p><span class="math display">\[D_{\bar{Q}_Y,g,a}(O) \equiv \frac{I(A=a)}{g(A|W)} (Y-\bar{Q}_Y(A,W)) + \bar{Q}_Y(A=a,W)\]</span></p>
<p>Note that under the randomization and positivity assumptions we have that
<span class="math inline">\(E[D_{\bar{Q}_Y,g,a}(O) | V] = E[Y_a |V].\)</span> We emphasize the double robust nature
of the A-IPW transform: consistency of <span class="math inline">\(E[Y_a |V]\)</span> will depend on correct estimation
of either <span class="math inline">\(\bar{Q}_{Y,0}(A,W)\)</span> or <span class="math inline">\(g_0(A|W)\)</span>. As such, in a randomized trial, we are
guaranteed a consistent estimate of <span class="math inline">\(E[Y_a |V]\)</span> even if we get <span class="math inline">\(\bar{Q}_{Y,0}(A,W)\)</span> wrong!</p>
<p>Using this transform, we can define the following contrast:</p>
<p><span class="math display">\[D_{\bar{Q}_Y,g}(O) = D_{\bar{Q}_Y,g,a=1}(O) - D_{\bar{Q}_Y,g,a=0}(O)\]</span></p>
<p>We estimate the blip function, <span class="math inline">\(\bar{Q}_{0,a}(V)\)</span>, by regressing <span class="math inline">\(D_{\bar{Q}_Y,g}(O)\)</span> on <span class="math inline">\(V\)</span> using
the specified <code>sl3</code> library of learners and an appropriate loss function.</p>
<ol start="3" style="list-style-type: decimal">
<li><p>Our estimated rule is <span class="math inline">\(d(V) = \text{argmax}_{a \in \mathcal{A}} \bar{Q}_{0,a}(V)\)</span>.</p></li>
<li><p>We obtain inference for the mean outcome under the estimated optimal rule using CV-TMLE.</p></li>
</ol>
<div id="evaluating-the-causal-effect-of-an-optimal-itr-with-binary-treatment" class="section level3">
<h3><span class="header-section-number">5.5.1</span> Evaluating the Causal Effect of an optimal ITR with Binary Treatment</h3>
<p>To start, let us load the packages we will use and set a seed for simulation:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(here)
<span class="kw">library</span>(data.table)
<span class="kw">library</span>(sl3)
<span class="kw">library</span>(tmle3)
<span class="kw">library</span>(tmle3mopttx)
<span class="kw">library</span>(devtools)
<span class="kw">set.seed</span>(<span class="dv">111</span>)</code></pre>
<div id="simulate-data" class="section level4">
<h4><span class="header-section-number">5.5.1.1</span> Simulate Data</h4>
<p>Our data generating distribution is of the following form:</p>
<p><span class="math display">\[W \sim \mathcal{N}(\bf{0},I_{3 \times 3})\]</span>
<span class="math display">\[P(A=1|W) = \frac{1}{1+\exp^{(-0.8*W_1)}}\]</span>
<span class="math display">\[P(Y=1|A,W) = 0.5\text{logit}^{-1}[-5I(A=1)(W_1-0.5)+5I(A=0)(W_1-0.5)] +
0.5\text{logit}^{-1}(W_2W_3)\]</span></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">&quot;data_bin&quot;</span>)</code></pre>
<ul>
<li><p>The above composes our observed data structure <span class="math inline">\(O = (W, A, Y)\)</span>.</p></li>
<li><p>Note that the mean under the true optimal rule is <span class="math inline">\(\psi=0.578\)</span> for this data generating
distribution.</p></li>
<li><p>Next, we specify the role that each variable in the data set plays as the nodes in a DAG.</p></li>
</ul>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># organize data and nodes for tmle3</span>
data &lt;-<span class="st"> </span>data_bin
node_list &lt;-<span class="st"> </span><span class="kw">list</span>(
  <span class="dt">W =</span> <span class="kw">c</span>(<span class="st">&quot;W1&quot;</span>, <span class="st">&quot;W2&quot;</span>, <span class="st">&quot;W3&quot;</span>),
  <span class="dt">A =</span> <span class="st">&quot;A&quot;</span>,
  <span class="dt">Y =</span> <span class="st">&quot;Y&quot;</span>
)</code></pre>
<ul>
<li>We now have an observed data structure (<code>data</code>), and a specification of the role
that each variable in the data set plays as the nodes in a DAG.</li>
</ul>
</div>
<div id="constructing-optimal-stacked-regressions-with-sl3" class="section level4">
<h4><span class="header-section-number">5.5.1.2</span> Constructing Optimal Stacked Regressions with <code>sl3</code></h4>
<ul>
<li>We generate three different ensemble learners that must be fit,
corresponding to the learners for the outcome regression, propensity score, and
the blip function.</li>
</ul>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Define sl3 library and metalearners:</span>
lrn_xgboost_<span class="dv">50</span> &lt;-<span class="st"> </span>Lrnr_xgboost<span class="op">$</span><span class="kw">new</span>(<span class="dt">nrounds =</span> <span class="dv">50</span>)
lrn_xgboost_<span class="dv">100</span> &lt;-<span class="st"> </span>Lrnr_xgboost<span class="op">$</span><span class="kw">new</span>(<span class="dt">nrounds =</span> <span class="dv">100</span>)
lrn_xgboost_<span class="dv">500</span> &lt;-<span class="st"> </span>Lrnr_xgboost<span class="op">$</span><span class="kw">new</span>(<span class="dt">nrounds =</span> <span class="dv">500</span>)
lrn_mean &lt;-<span class="st"> </span>Lrnr_mean<span class="op">$</span><span class="kw">new</span>()
lrn_glm &lt;-<span class="st"> </span>Lrnr_glm_fast<span class="op">$</span><span class="kw">new</span>()

## Define the Q learner:
Q_learner &lt;-<span class="st"> </span>Lrnr_sl<span class="op">$</span><span class="kw">new</span>(
  <span class="dt">learners =</span> <span class="kw">list</span>(lrn_xgboost_<span class="dv">50</span>, lrn_xgboost_<span class="dv">100</span>,
                  lrn_xgboost_<span class="dv">500</span>,lrn_mean, lrn_glm),
  <span class="dt">metalearner =</span> Lrnr_nnls<span class="op">$</span><span class="kw">new</span>()
)

## Define the g learner:
g_learner &lt;-<span class="st"> </span>Lrnr_sl<span class="op">$</span><span class="kw">new</span>(
  <span class="dt">learners =</span> <span class="kw">list</span>(lrn_xgboost_<span class="dv">100</span>, lrn_glm),
  <span class="dt">metalearner =</span> Lrnr_nnls<span class="op">$</span><span class="kw">new</span>()
)

## Define the B learner:
b_learner &lt;-<span class="st"> </span>Lrnr_sl<span class="op">$</span><span class="kw">new</span>(
  <span class="dt">learners =</span> <span class="kw">list</span>(lrn_xgboost_<span class="dv">50</span>, lrn_xgboost_<span class="dv">100</span>,
                  lrn_xgboost_<span class="dv">500</span>,lrn_mean, lrn_glm),
  <span class="dt">metalearner =</span> Lrnr_nnls<span class="op">$</span><span class="kw">new</span>()
)</code></pre>
<p>We make the above explicit with respect to standard
notation by bundling the ensemble learners into a list object below:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># specify outcome and treatment regressions and create learner list</span>
learner_list &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">Y =</span> Q_learner, <span class="dt">A =</span> g_learner, <span class="dt">B =</span> b_learner)</code></pre>
</div>
<div id="targeted-estimation-of-the-mean-under-the-optimal-individualized-interventions-effects" class="section level4">
<h4><span class="header-section-number">5.5.1.3</span> Targeted Estimation of the Mean under the Optimal Individualized Interventions Effects</h4>
<ul>
<li><p>To start, we will initialize a specification for the TMLE of our parameter of
interest simply by calling <code>tmle3_mopttx_blip_revere</code>.</p></li>
<li><p>We specify the argument <code>V = c(&quot;W1&quot;, &quot;W2&quot;, &quot;W3&quot;)</code> when initializing the <code>tmle3_Spec</code>
object in order to communicate that we’re interested in learning a rule dependent on <code>V</code>
covariates.</p></li>
<li><p>We also need to specify the type of blip we will use in this estimation problem, and
the list of learners used to estimate relevant parts of the likelihood and the blip function.</p></li>
<li><p>In addition, we need to specify whether we want to maximize or minimize the
mean outcome under the rule (<code>maximize=TRUE</code>).</p></li>
<li><p>If <code>complex=FALSE</code>, <code>tmle3mopttx</code> will consider all the possible rules under a smaller set of
covariates including the static rules, and optimize the mean outcome over all the
suboptimal rules dependent on <span class="math inline">\(V\)</span>.</p></li>
<li><p>If <code>realistic=TRUE</code>, only treatments supported by the data
will be considered, therefore alleviating concerns regarding practical positivity
issues.</p></li>
</ul>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># initialize a tmle specification</span>
tmle_spec &lt;-<span class="st"> </span><span class="kw">tmle3_mopttx_blip_revere</span>(
  <span class="dt">V =</span> <span class="kw">c</span>(<span class="st">&quot;W1&quot;</span>, <span class="st">&quot;W2&quot;</span>, <span class="st">&quot;W3&quot;</span>), <span class="dt">type =</span> <span class="st">&quot;blip1&quot;</span>,
  <span class="dt">learners =</span> learner_list,
  <span class="dt">maximize =</span> <span class="ot">TRUE</span>, <span class="dt">complex =</span> <span class="ot">TRUE</span>,
  <span class="dt">realistic =</span> <span class="ot">FALSE</span>
)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># fit the TML estimator</span>
fit &lt;-<span class="st"> </span><span class="kw">tmle3</span>(tmle_spec, data, node_list, learner_list)
fit</code></pre>
<pre><code>A tmle3_Fit that took 1 step(s)
   type         param  init_est  tmle_est         se     lower     upper
1:  TSM E[Y_{A=NULL}] 0.4289592 0.5701264 0.02749039 0.5162462 0.6240065
   psi_transformed lower_transformed upper_transformed
1:       0.5701264         0.5162462         0.6240065</code></pre>
<p>We can see that the confidence interval covers our true mean under the true optimal
individualized treatment!</p>
</div>
</div>
</div>
<div id="categorical-treatment" class="section level2">
<h2><span class="header-section-number">5.6</span> Categorical Treatment</h2>
<p><strong>QUESTION:</strong> Can we still use the blip function if the treatment is
categorical?</p>
<ul>
<li><p>In this section, we consider how to evaluate the mean outcome under the optimal
individualized treatment when <span class="math inline">\(A\)</span> has more than two categories!</p></li>
<li><p>We define <strong>pseudo-blips</strong> as vector valued entities where the output for a given
<span class="math inline">\(V\)</span> is a vector of length equal to the number of treatment categories, <span class="math inline">\(n_A\)</span>.
As such, we define it as:
<span class="math display">\[\bar{Q}_0^{pblip}(V) = \{\bar{Q}_{0,a}^{pblip}(V): a \in \mathcal{A} \}\]</span></p></li>
<li><p>We implement three different pseudo-blips in <code>tmle3mopttx</code>.</p></li>
</ul>
<ol style="list-style-type: decimal">
<li><p><strong>Blip1</strong> corresponds to choosing a reference category of treatment, and
defining the blip for all other categories relative to the specified reference:
<span class="math display">\[\bar{Q}_{0,a}^{pblip-ref}(V) \equiv E_0(Y_a-Y_0|V)\]</span></p></li>
<li><p><strong>Blip2</strong> approach corresponds to defining the blip relative to the average of
all categories:
<span class="math display">\[\bar{Q}_{0,a}^{pblip-avg}(V) \equiv E_0(Y_a- \frac{1}{n_A} \sum_{a \in \mathcal{A}} Y_a|V)\]</span></p></li>
<li><p><strong>Blip3</strong> reflects an extension of Blip2, where the average is now a weighted average:
<span class="math display">\[\bar{Q}_{0,a}^{pblip-wavg}(V) \equiv E_0(Y_a- \frac{1}{n_A} \sum_{a \in \mathcal{A}} Y_{a} P(A=a|V)
|V)\]</span></p></li>
</ol>
<div id="evaluating-the-causal-effect-of-an-optimal-itr-with-categorical-treatment" class="section level3">
<h3><span class="header-section-number">5.6.1</span> Evaluating the Causal Effect of an optimal ITR with Categorical Treatment</h3>
<p>While the procedure is analogous to the previously described binary treatment,
we now need to pay attention to the type of blip we define in the estimation stage,
as well as how we construct our learners.</p>
<div id="simulated-data" class="section level4">
<h4><span class="header-section-number">5.6.1.1</span> Simulated Data</h4>
<ul>
<li>First, we load the simulated data. Here, our data generating distribution was
of the following form:</li>
</ul>
<p><span class="math display">\[W \sim \mathcal{N}(\bf{0},I_{4 \times 4})\]</span>
<span class="math display">\[P(A|W) = \frac{1}{1+\exp^{(-(0.05*I(A=1)*W_1+0.8*I(A=2)*W_1+0.8*I(A=3)*W_1))}}\]</span></p>
<p><span class="math display">\[P(Y|A,W) = 0.5\text{logit}^{-1}[15I(A=1)(W_1-0.5) - 3I(A=2)(2W_1+0.5) \\
+ 3I(A=3)(3W_1-0.5)] +\text{logit}^{-1}(W_2W_1)\]</span></p>
<ul>
<li>We can just load the data available as part of the package as follows:</li>
</ul>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">&quot;data_cat_realistic&quot;</span>)</code></pre>
<ul>
<li>The above composes our observed data structure <span class="math inline">\(O = (W, A, Y)\)</span>. Note that the
mean under the true optimal rule is <span class="math inline">\(\psi=0.658\)</span>, which is the quantity we aim
to estimate.</li>
</ul>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># organize data and nodes for tmle3</span>
data &lt;-<span class="st"> </span>data_cat_realistic
node_list &lt;-<span class="st"> </span><span class="kw">list</span>(
  <span class="dt">W =</span> <span class="kw">c</span>(<span class="st">&quot;W1&quot;</span>, <span class="st">&quot;W2&quot;</span>, <span class="st">&quot;W3&quot;</span>, <span class="st">&quot;W4&quot;</span>),
  <span class="dt">A =</span> <span class="st">&quot;A&quot;</span>,
  <span class="dt">Y =</span> <span class="st">&quot;Y&quot;</span>
)</code></pre>
</div>
<div id="constructing-optimal-stacked-regressions-with-sl3-1" class="section level4">
<h4><span class="header-section-number">5.6.1.2</span> Constructing Optimal Stacked Regressions with <code>sl3</code></h4>
<p><strong>QUESTION:</strong> With categorical treatment, what is the dimension of the blip now?
How would we go about estimating it?</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Initialize few of the learners:</span>
lrn_xgboost_<span class="dv">50</span> &lt;-<span class="st"> </span>Lrnr_xgboost<span class="op">$</span><span class="kw">new</span>(<span class="dt">nrounds =</span> <span class="dv">50</span>)
lrn_xgboost_<span class="dv">100</span> &lt;-<span class="st"> </span>Lrnr_xgboost<span class="op">$</span><span class="kw">new</span>(<span class="dt">nrounds =</span> <span class="dv">100</span>)
lrn_xgboost_<span class="dv">500</span> &lt;-<span class="st"> </span>Lrnr_xgboost<span class="op">$</span><span class="kw">new</span>(<span class="dt">nrounds =</span> <span class="dv">500</span>)
lrn_mean &lt;-<span class="st"> </span>Lrnr_mean<span class="op">$</span><span class="kw">new</span>()
lrn_glm &lt;-<span class="st"> </span>Lrnr_glm_fast<span class="op">$</span><span class="kw">new</span>()

## Define the Q learner, which is just a regular learner:
Q_learner &lt;-<span class="st"> </span>Lrnr_sl<span class="op">$</span><span class="kw">new</span>(
  <span class="dt">learners =</span> <span class="kw">list</span>(lrn_xgboost_<span class="dv">50</span>, lrn_xgboost_<span class="dv">100</span>, lrn_xgboost_<span class="dv">500</span>, lrn_mean, lrn_glm),
  <span class="dt">metalearner =</span> Lrnr_nnls<span class="op">$</span><span class="kw">new</span>()
)

<span class="co"># Define the g learner, which is a multinomial learner:</span>
<span class="co">#specify the appropriate loss of the multinomial learner:</span>
mn_metalearner &lt;-<span class="st"> </span><span class="kw">make_learner</span>(Lrnr_solnp, <span class="dt">loss_function =</span> loss_loglik_multinomial,
                               <span class="dt">learner_function =</span> metalearner_linear_multinomial)
g_learner &lt;-<span class="st"> </span><span class="kw">make_learner</span>(Lrnr_sl, <span class="kw">list</span>(lrn_xgboost_<span class="dv">100</span>,lrn_xgboost_<span class="dv">500</span>,lrn_mean), mn_metalearner)

<span class="co"># Define the Blip learner, which is a multivariate learner:</span>
learners &lt;-<span class="st"> </span><span class="kw">list</span>(lrn_xgboost_<span class="dv">50</span>, lrn_xgboost_<span class="dv">100</span>, lrn_xgboost_<span class="dv">500</span>, lrn_mean, lrn_glm)
b_learner &lt;-<span class="st"> </span><span class="kw">create_mv_learners</span>(<span class="dt">learners =</span> learners)</code></pre>
<ul>
<li><p>We generate three different ensemble learners that must be fit,
corresponding to the learners for the outcome regression, propensity score, and the
blip function.</p></li>
<li><p>Note that we need to estimate <span class="math inline">\(g_0(A|W)\)</span> for a categorical <span class="math inline">\(A\)</span>- therefore
we use the multinomial Super Learner option available within the <code>sl3</code> package with learners
that can address multi-class classification problems.</p></li>
<li><p>In order to see which learners can
be used to estimate <span class="math inline">\(g_0(A|W)\)</span> in <code>sl3</code>, we run the following:</p></li>
</ul>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># See which learners support multi-class classification:</span>
<span class="kw">sl3_list_learners</span>(<span class="kw">c</span>(<span class="st">&quot;categorical&quot;</span>))</code></pre>
<pre><code> [1] &quot;Lrnr_bartMachine&quot;          &quot;Lrnr_dbarts&quot;              
 [3] &quot;Lrnr_glmnet&quot;               &quot;Lrnr_grf&quot;                 
 [5] &quot;Lrnr_h2o_glm&quot;              &quot;Lrnr_h2o_grid&quot;            
 [7] &quot;Lrnr_independent_binomial&quot; &quot;Lrnr_mean&quot;                
 [9] &quot;Lrnr_multivariate&quot;         &quot;Lrnr_optim&quot;               
[11] &quot;Lrnr_randomForest&quot;         &quot;Lrnr_ranger&quot;              
[13] &quot;Lrnr_rpart&quot;                &quot;Lrnr_solnp&quot;               
[15] &quot;Lrnr_svm&quot;                  &quot;Lrnr_xgboost&quot;             </code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># specify outcome and treatment regressions and create learner list</span>
learner_list &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">Y =</span> Q_learner, <span class="dt">A =</span> g_learner, <span class="dt">B =</span> b_learner)</code></pre>
</div>
<div id="targeted-estimation-of-the-mean-under-the-optimal-individualized-interventions-effects-1" class="section level4">
<h4><span class="header-section-number">5.6.1.3</span> Targeted Estimation of the Mean under the Optimal Individualized Interventions Effects</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># initialize a tmle specification</span>
tmle_spec &lt;-<span class="st"> </span><span class="kw">tmle3_mopttx_blip_revere</span>(
  <span class="dt">V =</span> <span class="kw">c</span>(<span class="st">&quot;W1&quot;</span>, <span class="st">&quot;W2&quot;</span>, <span class="st">&quot;W3&quot;</span>, <span class="st">&quot;W4&quot;</span>), <span class="dt">type =</span> <span class="st">&quot;blip2&quot;</span>,
  <span class="dt">learners =</span> learner_list, <span class="dt">maximize =</span> <span class="ot">TRUE</span>, <span class="dt">complex =</span> <span class="ot">TRUE</span>,
  <span class="dt">realistic =</span> <span class="ot">FALSE</span>
)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># fit the TML estimator</span>
fit &lt;-<span class="st"> </span><span class="kw">tmle3</span>(tmle_spec, data, node_list, learner_list)
fit</code></pre>
<pre><code>A tmle3_Fit that took 1 step(s)
   type         param  init_est  tmle_est         se     lower     upper
1:  TSM E[Y_{A=NULL}] 0.5453711 0.6556743 0.06308402 0.5320319 0.7793167
   psi_transformed lower_transformed upper_transformed
1:       0.6556743         0.5320319         0.7793167</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># How many individuals got assigned each treatment?</span>
<span class="kw">table</span>(tmle_spec<span class="op">$</span>return_rule)</code></pre>
<pre><code>
  1   2   3 
309 423 268 </code></pre>
<p>We can see that the confidence interval covers
our true mean under the true optimal individualized treatment.</p>
<p><strong>NOTICE the distribution of the assigned treatment! We will need this shortly.</strong></p>
</div>
</div>
</div>
<div id="extensions-to-causal-effect-of-an-oit" class="section level2">
<h2><span class="header-section-number">5.7</span> Extensions to Causal Effect of an OIT</h2>
<ul>
<li><p>We consider two extensions to the procedure described for
estimating the value of the ITR.</p></li>
<li><p>The first one considers a setting where the user
might be interested in a grid of possible suboptimal rules, corresponding to
potentially limited knowledge of potential effect modifiers (<strong>Simpler Rules</strong>).</p></li>
<li><p>The second extension concerns implementation of realistic optimal individual
interventions where certain regimes might be preferred, but due to practical or
global positivity restraints are not realistic to implement (<strong>Realistic Interventions</strong>).</p></li>
</ul>
<div id="simpler-rules" class="section level3">
<h3><span class="header-section-number">5.7.1</span> Simpler Rules</h3>
<ul>
<li><p>In order to not only consider the most ambitious fully <span class="math inline">\(V\)</span>-optimal rule, we
define <span class="math inline">\(S\)</span>-optimal rules as the optimal rule that considers all possible subsets
of <span class="math inline">\(V\)</span> covariates, with card(<span class="math inline">\(S\)</span>) <span class="math inline">\(\leq\)</span> card(<span class="math inline">\(V\)</span>) and <span class="math inline">\(\emptyset \in S\)</span>.</p></li>
<li><p>This allows us to consider sub-optimal rules that are easier to estimate and
potentially provide more realistic rules- as such, we allow for statistical
inference for the counterfactual mean outcome under the sub-optimal rule.</p></li>
</ul>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># initialize a tmle specification</span>
tmle_spec &lt;-<span class="st"> </span><span class="kw">tmle3_mopttx_blip_revere</span>(
  <span class="dt">V =</span> <span class="kw">c</span>(<span class="st">&quot;W4&quot;</span>, <span class="st">&quot;W3&quot;</span>, <span class="st">&quot;W2&quot;</span>, <span class="st">&quot;W1&quot;</span>), <span class="dt">type =</span> <span class="st">&quot;blip2&quot;</span>,
  <span class="dt">learners =</span> learner_list,
  <span class="dt">maximize =</span> <span class="ot">TRUE</span>, <span class="dt">complex =</span> <span class="ot">FALSE</span>, <span class="dt">realistic =</span> <span class="ot">FALSE</span>
)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># fit the TML estimator</span>
fit &lt;-<span class="st"> </span><span class="kw">tmle3</span>(tmle_spec, data, node_list, learner_list)
fit</code></pre>
<pre><code>A tmle3_Fit that took 1 step(s)
   type       param  init_est  tmle_est         se     lower     upper
1:  TSM E[Y_{A=W1}] 0.5467154 0.6165962 0.06864943 0.4820458 0.7511466
   psi_transformed lower_transformed upper_transformed
1:       0.6165962         0.4820458         0.7511466</code></pre>
<p>Even though the user specified all baseline covariates as the basis
for rule estimation, a simpler rule is sufficient to
maximize the mean under the optimal individualized treatment!</p>
<p><strong>QUESTION:</strong> Why do you think the estimate
is higher under the less complex rule? How does the set of covariates picked by <code>tmle3mopttx</code>
compare to the baseline covariates the true rule depends on?</p>
</div>
<div id="realistic-optimal-individual-regimes" class="section level3">
<h3><span class="header-section-number">5.7.2</span> Realistic Optimal Individual Regimes</h3>
<ul>
<li><p><code>tmle3mopttx</code> also provides an option to estimate the mean under the
realistic, or implementable, optimal individualized treatment.</p></li>
<li><p>It is often the case that assigning particular regime might have the ability to
fully maximize (or minimize) the desired outcome, but due to
global or practical positivity constrains, such treatment
can never be implemented in real life (or is highly unlikely).</p></li>
<li><p>Specifying <code>realistic=&quot;TRUE&quot;</code>, we consider possibly suboptimal
treatments that optimize the outcome in question while being
supported by the data.</p></li>
</ul>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># initialize a tmle specification</span>
tmle_spec &lt;-<span class="st"> </span><span class="kw">tmle3_mopttx_blip_revere</span>(
  <span class="dt">V =</span> <span class="kw">c</span>(<span class="st">&quot;W4&quot;</span>, <span class="st">&quot;W3&quot;</span>, <span class="st">&quot;W2&quot;</span>, <span class="st">&quot;W1&quot;</span>), <span class="dt">type =</span> <span class="st">&quot;blip2&quot;</span>,
  <span class="dt">learners =</span> learner_list,
  <span class="dt">maximize =</span> <span class="ot">TRUE</span>, <span class="dt">complex =</span> <span class="ot">TRUE</span>, <span class="dt">realistic =</span> <span class="ot">TRUE</span>
)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># fit the TML estimator</span>
fit &lt;-<span class="st"> </span><span class="kw">tmle3</span>(tmle_spec, data, node_list, learner_list)
fit</code></pre>
<pre><code>A tmle3_Fit that took 1 step(s)
   type         param  init_est tmle_est         se     lower     upper
1:  TSM E[Y_{A=NULL}] 0.5536721 0.652745 0.02144985 0.6107041 0.6947859
   psi_transformed lower_transformed upper_transformed
1:        0.652745         0.6107041         0.6947859</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># How many individuals got assigned each treatment?</span>
<span class="kw">table</span>(tmle_spec<span class="op">$</span>return_rule)</code></pre>
<pre><code>
  2   3 
500 500 </code></pre>
<p><strong>QUESTION:</strong> Referring back to the data-generating distribution, why do you
think the distribution of allocated treatment changed from the distribution
that we had under the “non-realistic” rule?</p>
</div>
<div id="variable-importance-analysis" class="section level3">
<h3><span class="header-section-number">5.7.3</span> Variable Importance Analysis</h3>
<ul>
<li><p>In the previous sections we have seen how to obtain a contrast between the
mean under the optimal individualized rule and the mean under the observed outcome for a
single covariate. We are now ready to run the variable importance analysis for all of our
observed covariates!</p></li>
<li><p>In order to run <code>tmle3mopttx</code> variable importance measure, we
need considered covariates to be categorical variables.</p></li>
<li><p>For illustration purpose,
we bin baseline covariates corresponding to the data-generating distribution
described in the previous section:</p></li>
</ul>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># bin baseline covariates to 3 categories:</span>
data<span class="op">$</span>W1&lt;-<span class="kw">ifelse</span>(data<span class="op">$</span>W1<span class="op">&lt;</span><span class="kw">quantile</span>(data<span class="op">$</span>W1)[<span class="dv">2</span>],<span class="dv">1</span>,<span class="kw">ifelse</span>(data<span class="op">$</span>W1<span class="op">&lt;</span><span class="kw">quantile</span>(data<span class="op">$</span>W1)[<span class="dv">3</span>],<span class="dv">2</span>,<span class="dv">3</span>))

node_list &lt;-<span class="st"> </span><span class="kw">list</span>(
  <span class="dt">W =</span> <span class="kw">c</span>(<span class="st">&quot;W3&quot;</span>, <span class="st">&quot;W4&quot;</span>, <span class="st">&quot;W2&quot;</span>),
  <span class="dt">A =</span> <span class="kw">c</span>(<span class="st">&quot;W1&quot;</span>, <span class="st">&quot;A&quot;</span>),
  <span class="dt">Y =</span> <span class="st">&quot;Y&quot;</span>
)</code></pre>
<ul>
<li>Note that our node list now includes <span class="math inline">\(W_1\)</span> as treatments as well!
Don’t worry, we will still properly adjust for all baseline covariates when
considering <span class="math inline">\(A\)</span> as treatment.</li>
</ul>
<div id="variable-importance-using-targeted-estimation-of-the-value-of-the-itr" class="section level4">
<h4><span class="header-section-number">5.7.3.1</span> Variable Importance using Targeted Estimation of the value of the ITR</h4>
<ul>
<li>We will initialize a specification for the TMLE of our parameter of
interest (called a <code>tmle3_Spec</code> in the <code>tlverse</code> nomenclature) simply by calling
<code>tmle3_mopttx_vim</code>.</li>
</ul>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># initialize a tmle specification</span>
tmle_spec &lt;-<span class="st"> </span><span class="kw">tmle3_mopttx_vim</span>(
  <span class="dt">V=</span><span class="kw">c</span>(<span class="st">&quot;W2&quot;</span>),
  <span class="dt">type =</span> <span class="st">&quot;blip2&quot;</span>,
  <span class="dt">learners =</span> learner_list,
  <span class="dt">contrast =</span> <span class="st">&quot;multiplicative&quot;</span>,
  <span class="dt">maximize =</span> <span class="ot">FALSE</span>,
  <span class="dt">method =</span> <span class="st">&quot;SL&quot;</span>,
  <span class="dt">complex =</span> <span class="ot">TRUE</span>,
  <span class="dt">realistic =</span> <span class="ot">FALSE</span>
)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># fit the TML estimator</span>
vim_results &lt;-<span class="st"> </span><span class="kw">tmle3_vim</span>(tmle_spec, data, node_list, learner_list,
  <span class="dt">adjust_for_other_A =</span> <span class="ot">TRUE</span>
)

<span class="kw">print</span>(vim_results)</code></pre>
<pre><code>   type                  param      init_est    tmle_est         se       lower
1:   RR RR(E[Y_{A=NULL}]/E[Y]) -0.0195466266 -0.02970447 0.04794113 -0.12366736
2:   RR RR(E[Y_{A=NULL}]/E[Y])  0.0001828497  0.03305568 0.03440590 -0.03437865
        upper psi_transformed lower_transformed upper_transformed  A
1: 0.06425843       0.9707324         0.8836737          1.066368 W1
2: 0.10049002       1.0336081         0.9662056          1.105713  A
             W     Z_stat      p_nz p_nz_corrected
1:  W3,W4,W2,A -0.6196029 0.2677596      0.2677596
2: W3,W4,W2,W1  0.9607562 0.1683374      0.2677596</code></pre>
<p>The final result of <code>tmle3_vim</code> with the <code>tmle3mopttx</code> spec is an ordered list
of mean outcomes under the optimal individualized treatment for all categorical
covariates in our dataset.</p>
</div>
</div>
</div>
<div id="exercise-2" class="section level2">
<h2><span class="header-section-number">5.8</span> Exercise</h2>
<div id="real-world-data-and-tmle3mopttx" class="section level3">
<h3><span class="header-section-number">5.8.1</span> Real World Data and <code>tmle3mopttx</code></h3>
<p>Finally, we cement everything we learned so far with a real data application.</p>
<p>As in the previous sections, we will be using the WASH Benefits data,
corresponding to the Effect of water quality, sanitation, hand washing, and
nutritional interventions on child development in rural Bangladesh trial.</p>
<p>The main aim of the cluster-randomized controlled trial was to assess the
impact of six intervention groups, including:</p>
<ol style="list-style-type: decimal">
<li><p>Control</p></li>
<li><p>Handwashing with soap</p></li>
<li><p>Improved nutrition through counselling and provision of lipid-based nutrient supplements</p></li>
<li><p>Combined water, sanitation, handwashing, and nutrition.</p></li>
<li><p>Improved sanitation</p></li>
<li><p>Combined water, sanitation, and handwashing</p></li>
<li><p>Chlorinated drinking water</p></li>
</ol>
<p>We aim to estimate the optimal ITR and the corresponding value under the optimal ITR
for the main intervention in WASH Benefits data!</p>
<p>Our outcome of interest is the weight-for-height Z-score, whereas our treatment is
the six intervention groups aimed at improving living conditions.</p>
<p><strong>Work with a buddy. You have 20 minutes.</strong></p>
<p>In the etherpad, submit your group’s answers to the following questions.</p>
<ol style="list-style-type: decimal">
<li><p>Define <span class="math inline">\(V\)</span> as mother’s education (<code>momedu</code>), current living conditions (<code>floor</code>),
and possession of material items including the refrigerator (<code>asset_refrig</code>).
Why do you think we use these covariates as <span class="math inline">\(V\)</span>?
Do we want to minimize or maximize the outcome? Which blip type should we use?
Construct an approprite <code>sl3</code> library for <span class="math inline">\(A\)</span>, <span class="math inline">\(Y\)</span> and <span class="math inline">\(B\)</span>.</p></li>
<li><p>Based on the <span class="math inline">\(V\)</span> defined in the previous question, estimate the mean under the ITR for
the main randomized intervention used in the WASH Benefits trial
with weight-for-height Z-score as the outcome. What’s the TMLE value of the optimal ITR?
How does it change from the initial estimate? Which intervention is the most dominant?
Why do you think that is?</p></li>
<li><p>Using the same formulation as in questions 1 and 2, estimate the realistic optimal ITR
and the corresponding value of the realistic ITR. Did the results change? Which intervention
is the most dominant under realistic rules? Why do you think that is?</p></li>
</ol>
</div>
</div>
<div id="summary-2" class="section level2">
<h2><span class="header-section-number">5.9</span> Summary</h2>
<ul>
<li><p>In summary, the mean outcome under the optimal individualized treatment is a counterfactual
quantity of interest representing what the mean outcome would have been if everybody, contrary
to the fact, received treatment that optimized their outcome.</p></li>
<li><p><code>tmle3mopttx</code> estimates the mean outcome under the optimal individualized treatment, where the candidate
rules are restricted to only respond to a user-supplied subset of the baseline and intermediate
covariates. In addition it provides options for realistic, data-adaptive interventions.</p></li>
<li><p>In essence, our target parameter answers the key aim of precision medicine: allocating
the available treatment by tailoring it to the individual characteristics of the patient, with the
goal of optimizing the final outcome.</p></li>
</ul>
<div id="solutions" class="section level3">
<h3><span class="header-section-number">5.9.1</span> Solutions</h3>
<p>To start, let’s load the data, convert all columns to be of class <code>numeric</code>,
and take a quick look at it:</p>
<pre class="sourceCode r"><code class="sourceCode r">washb_data &lt;-<span class="st"> </span><span class="kw">fread</span>(<span class="st">&quot;https://raw.githubusercontent.com/tlverse/tlverse-data/master/wash-benefits/washb_data.csv&quot;</span>, <span class="dt">stringsAsFactors =</span> <span class="ot">TRUE</span>)
washb_data &lt;-<span class="st"> </span>washb_data[<span class="op">!</span><span class="kw">is.na</span>(momage), <span class="kw">lapply</span>(.SD, as.numeric)]
<span class="kw">head</span>(washb_data, <span class="dv">3</span>)</code></pre>
<p>As before, we specify the NPSEM via the <code>node_list</code> object.</p>
<pre class="sourceCode r"><code class="sourceCode r">node_list &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">W =</span> <span class="kw">names</span>(washb_data)[<span class="op">!</span>(<span class="kw">names</span>(washb_data) <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;whz&quot;</span>, <span class="st">&quot;tr&quot;</span>))],
                  <span class="dt">A =</span> <span class="st">&quot;tr&quot;</span>, <span class="dt">Y =</span> <span class="st">&quot;whz&quot;</span>)</code></pre>
<p>We pick few potential effect modifiers, including mother’s education, current
living conditions (floor), and possession of material items including the refrigerator.
We concentrate of these covariates as they might be indicative of the socio-economic status
of individuals involved in the trial. We can explore the distribution of our <span class="math inline">\(V\)</span>, <span class="math inline">\(A\)</span> and <span class="math inline">\(Y\)</span>:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co">#V1, V2 and V3:</span>
<span class="kw">table</span>(washb_data<span class="op">$</span>momedu)
<span class="kw">table</span>(washb_data<span class="op">$</span>floor)
<span class="kw">table</span>(washb_data<span class="op">$</span>asset_refrig)

<span class="co">#A:</span>
<span class="kw">table</span>(washb_data<span class="op">$</span>tr)

<span class="co">#Y:</span>
<span class="kw">summary</span>(washb_data<span class="op">$</span>whz)</code></pre>
<p>We specify a simply library for the outcome regression, propensity score
and the blip function. Since our treatment is categorical, we need to define a
multinomial learner for <span class="math inline">\(A\)</span> and multivariate learner for <span class="math inline">\(B\)</span>. We
will define the <code>xgboost</code> over a grid of parameters, and initialize a mean learner.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Initialize few of the learners:</span>
grid_params =<span class="st"> </span><span class="kw">list</span>(<span class="dt">nrounds =</span> <span class="kw">c</span>(<span class="dv">100</span>, <span class="dv">500</span>),
                     <span class="dt">eta =</span> <span class="kw">c</span>(<span class="fl">0.01</span>, <span class="fl">0.1</span>))
grid =<span class="st"> </span><span class="kw">expand.grid</span>(grid_params, <span class="dt">KEEP.OUT.ATTRS =</span> <span class="ot">FALSE</span>)
xgb_learners =<span class="st"> </span><span class="kw">apply</span>(grid, <span class="dt">MARGIN =</span> <span class="dv">1</span>, <span class="cf">function</span>(params_tune) {
    <span class="kw">do.call</span>(Lrnr_xgboost<span class="op">$</span>new, <span class="kw">c</span>(<span class="kw">as.list</span>(params_tune)))
  })
lrn_mean &lt;-<span class="st"> </span>Lrnr_mean<span class="op">$</span><span class="kw">new</span>()

## Define the Q learner, which is just a regular learner:
Q_learner &lt;-<span class="st"> </span>Lrnr_sl<span class="op">$</span><span class="kw">new</span>(
  <span class="dt">learners =</span> <span class="kw">list</span>(xgb_learners[[<span class="dv">1</span>]], xgb_learners[[<span class="dv">2</span>]], xgb_learners[[<span class="dv">3</span>]],
                  xgb_learners[[<span class="dv">4</span>]], lrn_mean),
  <span class="dt">metalearner =</span> Lrnr_nnls<span class="op">$</span><span class="kw">new</span>()
)

<span class="co"># Define the g learner, which is a multinomial learner:</span>
<span class="co">#specify the appropriate loss of the multinomial learner:</span>
mn_metalearner &lt;-<span class="st"> </span><span class="kw">make_learner</span>(Lrnr_solnp, <span class="dt">loss_function =</span> loss_loglik_multinomial,
                               <span class="dt">learner_function =</span> metalearner_linear_multinomial)
g_learner &lt;-<span class="st"> </span><span class="kw">make_learner</span>(Lrnr_sl, <span class="kw">list</span>(xgb_learners[[<span class="dv">4</span>]], lrn_mean), mn_metalearner)

<span class="co"># Define the Blip learner, which is a multivariate learner:</span>
learners &lt;-<span class="st"> </span><span class="kw">list</span>(xgb_learners[[<span class="dv">1</span>]], xgb_learners[[<span class="dv">2</span>]], xgb_learners[[<span class="dv">3</span>]],
                  xgb_learners[[<span class="dv">4</span>]], lrn_mean)
b_learner &lt;-<span class="st"> </span><span class="kw">create_mv_learners</span>(<span class="dt">learners =</span> learners)

learner_list &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">Y =</span> Q_learner, <span class="dt">A =</span> g_learner, <span class="dt">B =</span> b_learner)</code></pre>
<p>As seen before, we initialize the <code>tmle3_mopttx_blip_revere</code> Specn in order to
answer Question 1. We want to maximize our outcome, with higher the weight-for-height Z-score
the better. We will also use <code>blip2</code> as the blip type, but note that we could have used <code>blip1</code>
as well since “Control” is a good reference category.</p>
<pre class="sourceCode r"><code class="sourceCode r">## Question 2:

<span class="co">#Initialize a tmle specification</span>
tmle_spec &lt;-<span class="st"> </span><span class="kw">tmle3_mopttx_blip_revere</span>(
  <span class="dt">V =</span> <span class="kw">c</span>(<span class="st">&quot;momedu&quot;</span>, <span class="st">&quot;floor&quot;</span>, <span class="st">&quot;asset_refrig&quot;</span>), <span class="dt">type =</span> <span class="st">&quot;blip2&quot;</span>,
  <span class="dt">learners =</span> learner_list, <span class="dt">maximize =</span> <span class="ot">TRUE</span>, <span class="dt">complex =</span> <span class="ot">TRUE</span>,
  <span class="dt">realistic =</span> <span class="ot">FALSE</span>
)

<span class="co">#Fit the TML estimator.</span>
fit &lt;-<span class="st"> </span><span class="kw">tmle3</span>(tmle_spec, <span class="dt">data=</span>washb_data, node_list, learner_list)
fit

<span class="co">#Which intervention is the most dominant?</span>
<span class="kw">table</span>(tmle_spec<span class="op">$</span>return_rule)</code></pre>
<p>Using the same formulation as before, we estimate the realistic optimal ITR
and the corresponding value of the realistic ITR:</p>
<pre class="sourceCode r"><code class="sourceCode r">## Question 3:

<span class="co">#Initialize a tmle specification with &quot;realistic=TRUE&quot;:</span>
tmle_spec &lt;-<span class="st"> </span><span class="kw">tmle3_mopttx_blip_revere</span>(
  <span class="dt">V =</span> <span class="kw">c</span>(<span class="st">&quot;momedu&quot;</span>, <span class="st">&quot;floor&quot;</span>, <span class="st">&quot;asset_refrig&quot;</span>), <span class="dt">type =</span> <span class="st">&quot;blip2&quot;</span>,
  <span class="dt">learners =</span> learner_list, <span class="dt">maximize =</span> <span class="ot">TRUE</span>, <span class="dt">complex =</span> <span class="ot">TRUE</span>,
  <span class="dt">realistic =</span> <span class="ot">TRUE</span>
)

<span class="co">#Fit the TML estimator.</span>
fit &lt;-<span class="st"> </span><span class="kw">tmle3</span>(tmle_spec, <span class="dt">data=</span>washb_data, node_list, learner_list)
fit

<span class="kw">table</span>(tmle_spec<span class="op">$</span>return_rule)</code></pre>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="the-tmle-framework.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="stochastic-treatment-regimes.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/tlverse/acic2019-workshop/edit/master/06-tmle3mopttx.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"download": ["acic2019_workshop.pdf", "acic2019_workshop.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
