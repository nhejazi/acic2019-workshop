# `tmle3` -- Targeted Learning Framework


## Learning Objectives
<!--- appears as "X.1: Learning Objectives" in the book, where X is the chapter
corresponding to stochastic interventions -->
1. Use `tmle3` to estimate an Average Treatment Effect (ATE)
2. Understand `tmle3` "Specs"
3. Fit `tmle3` for a custom set of parameters
4. Use the delta method to estimate transformations of parameters

## Example: `tmle3` for ATE

### Load the Data

We'll use the same WASH Benefits data as the earlier chapters:

```{r tmle3-load-data}
library(tmle3)
library(sl3)
library(data.table)
washb_data <- fread("../washb_data/washb_data.csv", stringsAsFactors = TRUE)
str(washb_data)
```

### Define the variable roles

We'll use the common W (covariates), A (treatment/intervention), Y (outcome) data structure. `tmle3` needs to know what variables in the dataset correspond to each of these roles. We use a list of character vectors to tell it. We call this a "Node List" as it corresponds to the nodes in a Directed Acyclic Graph (DAG), a way of displaying causal relationships between variables.

```{r tmle3-node-list}
node_list <- list(W = c("month", "aged", "sex", "momage", "momedu", 
                        "momheight", "hfiacat", "Nlt18", "Ncomp", "watmin", "elec", "floor", 
                        "walls", "roof", "asset_wardrobe", "asset_table", "asset_chair", 
                        "asset_khat", "asset_chouki", "asset_tv", "asset_refrig", "asset_bike", 
                        "asset_moto", "asset_sewmach", "asset_mobile"),
                  A = "tr",
                  Y = "whz")
```

### Handle Missingness

Currently, missingness in `tmle3` is handled in a fairly simple way:

* Missing covariates are median (for continuous) or mode (for discrete) imputed, and additional covariates indicating imputation are generated
* Observations missing either treatment or outcome variables are excluded.

We plan to implement IPCW-TMLE to more efficiently handle missingness in the treatment and outcome variables.

These steps are implemented in the `process_missing` function in `tmle3`:

```{r tmle3-process_missing}
processed <- process_missing(washb_data, node_list)
washb_data <- processed$data
node_list <- processed$node_list
```

### Create a "Spec" Object

`tmle3` is general, and allows most components of the TMLE procedure to be specified in a modular way. 
However, most end-users will not be interested in manually specifying all of these components. Therefore, 
`tmle3` implements a `tmle3_Spec` object that bundles a set ofcomponents into a _specification_ that, 
with minimal additional detail, can be run by an end-user.

We'll start with using one of the specs, and then work our way down into the internals of `tmle3`.

```{r tmle3-ate-spec}

ate_spec <- tmle_ATE(treatment_level= "Nutrition + WSH",control_level = "Control")
```

### Define the learners


Currently, the only other thng a user must define are the `sl3` learners used to estimate the relevant factors of the likelihood: Q and g.

This takes the form of a list of `sl3` learners, one for each likelihood factor to be estimated with `sl3`:

<!-- TODO: use learners defned in Rachael's section -->

```{r tmle3-learner-list}
lrnr_glm <- make_learner(Lrnr_glm)
lrnr_mean <- make_learner(Lrnr_mean)
learner_list <- list(A = lrnr_mean, Y = lrnr_glm)
```

We plan to include reasonable defaults for this as well.

### Fit the TMLE

We now have everything we need to fit the tmle using `tmle3`:

```{r tmle3-spec-fit}
suppressWarnings({
tmle3_fit <- tmle3(ate_spec, washb_data, node_list, learner_list)
})
```


### Evaluate the Estimates

```{r tmle3-spec-summary}
print(tmle3_fit)

estimates <- tmle3_fit$summary$psi_transformed
print(estimates)
```

## `tmle3` Specs

```{r tmle3-spec-components}
tmle_task <- ate_spec$make_tmle_task(washb_data, node_list)
initial_likelihood <- ate_spec$make_initial_likelihood(tmle_task, learner_list)
targeted_likelihood <- Targeted_Likelihood$new(initial_likelihood)
params <- ate_spec$make_params(tmle_task, targeted_likelihood)
```
General concept


### tmle_task

### initial likelihood

### targeted likelihood (updater)

### parameters

### finding specs

## Defining new parameters

## Delta method